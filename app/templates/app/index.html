{% extends 'app/base.html' %}

{% load humanize %}
{% load url_params %}
{% load static %}

{% block meta %}
    {{ block.super }}
    <link id="updates-feed-link" rel="alternate" type="application/rss+xml" title="RSS" href="{{ feed_url }}">
{% endblock %}

{% block title %}Charge Beacon - EV Charging Station Updates{% endblock %}

{% block style_extra %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'app/css/autocomplete.css' %}">
{% endblock %}

{% block script_extra %}
    <script src="{% static 'app/js/autocomplete.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const interestingFields = [
                'ev_state',
                'ev_network',
                'dc_fast',
                'only_new',
                'plug_types',
            ];

            const form = document.getElementById('search-inputs');
            const feedLink = document.getElementById('updates-feed-link');
            const feedAnchor = document.getElementById('updates-feed-anchor');

            for (const field of interestingFields) {
                const el = document.getElementById(field);
                el.addEventListener('change', function () {
                    const formData = new FormData(form);
                    const params = new URLSearchParams(formData);
                    window.history.pushState({}, '', `?${params.toString()}`);
                    const newFullURL = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
                    feedLink.href = newFullURL;
                    feedAnchor.href = newFullURL;
                    fetch(`/updates_partial?${params.toString()}`)
                        .then(response => response.text())
                        .then(html => {
                            const container = document.getElementById('updates-container');
                            container.innerHTML = html;
                        });
                });
            }
        });
    </script>
{% endblock %}

{% block content %}
    {% include 'app/header.html' %}

    <div class="filter-instructions">
        <p>
            <strong>Step 1: </strong>Configure a filter
        </p>
        <p>
            <strong>Step 2: </strong>Subscribe to the
            <a id="updates-feed-anchor" href="{{ feed_url }}">RSS feed</a>
            (more ways to subscribe coming soon!)
        </p>
    </div>
    <div class="filter-header">
    <form id="search-inputs" method="get">
        <div class="search-form">
            <div class="search-input">
                <label for="ev_state">States</label>
                <select name="ev_state" id="ev_state" multiple data-multi-select-plugin>
                    {% for state in states %}
                        <option value="{{ state.id }}"
                                {% if state.id in selected_states %}selected{% endif %}>
                            {{ state.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="search-input">
                <label for="ev_network">EV Networks</label>
                <select name="ev_network" id="ev_network" multiple data-multi-select-plugin>
                    {% for ev_network in networks %}
                        <option value="{{ ev_network.id }}"
                                {% if ev_network.id in selected_networks %}selected{% endif %}>
                            {{ ev_network.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="search-input">
                <label for="plug_types">Plug Types</label>
                <select name="plug_types" id="plug_types" multiple data-multi-select-plugin>
                    <option value="">Any</option>
                    {% for plug_value, plug_name in plug_types.items %}
                        <option value="{{ plug_value }}"
                                {% if plug_value in selected_plug_types %}selected{% endif %}>
                            {{ plug_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="search-input-group">
                <div class="search-input">
                    <label for="dc_fast">DC Fast</label>
                    <input type="checkbox" name="dc_fast" id="dc_fast" value="true"
                           {% if request.GET.dc_fast == 'true' %}checked{% endif %}>
                </div>
                <div class="search-input">
                    <label for="only_new">Only Show New</label>
                    <input type="checkbox" name="only_new" id="only_new" value="true"
                           {% if request.GET.only_new == 'true' %}checked{% endif %}>
                </div>
            </div>
        </div>
    </form>
    </div>

    <div class="updates-container" id="updates-container">
        {% include 'app/updates_body.html' %}
    </div>

    <div class="footer">
        <div class="footer-links">
            <span>Created by<br><a href="https://sam.sutch.net" target="_blank">Samuel Sutch</a></span><br>
            <span>Data provided by<br><a href="https://developer.nrel.gov/" target="_blank">NREL</a></span><br>
            <span>Find us on<br><a href="https://github.com/charge-beacon/charge-beacon"
                                   target="_blank">GitHub</a></span>
        </div>
    </div>
{% endblock %}
