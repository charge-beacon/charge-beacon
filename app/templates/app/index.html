{% extends 'app/bs_base.html' %}

{% load humanize %}
{% load url_params %}
{% load static %}

{% block meta %}
    {{ block.super }}
    <link id="updates-feed-link" rel="alternate" type="application/rss+xml" title="RSS" href="{{ feed_url }}">
{% endblock %}

{% block title %}Charge Beacon - EV Charging Station Updates{% endblock %}

{% block style_extra %}
    {{ block.super }}
    {% include 'app/search/search_styles.html' %}
{% endblock %}

{% block script_extra %}
    {{ block.super }}
    {% include 'app/search/search_scripts.html' %}
    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            // listen for updates in the search form and update the feed
            const interestingFields = [
                'ev_area',
                'ev_network',
                'dc_fast',
                'only_new',
                'plug_types',
            ];

            const form = document.getElementById('search-inputs');
            const feedLink = document.getElementById('updates-feed-link');
            const feedAnchor = document.getElementById('updates-feed-anchor');

            for (const field of interestingFields) {
                const el = document.getElementById(field);
                el.addEventListener('change', function () {
                    const formData = new FormData(form);
                    const params = new URLSearchParams(formData);
                    window.history.pushState({}, '', `?${params.toString()}`);
                    const newFullURL = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
                    feedLink.href = newFullURL;
                    feedAnchor.href = newFullURL;
                    fetch(`/updates_partial?${params.toString()}`)
                        .then(response => response.text())
                        .then(html => {
                            const container = document.getElementById('updates-container');
                            container.innerHTML = html;
                        });
                });
            }

            // connect click of entire station update card to station url
            document.querySelectorAll('[data-station-card-url]').forEach(el => {
                el.onclick = () => {
                    location.href = el.dataset.stationCardUrl;
                }
            });
        });
    </script>
{% endblock %}

{% block container_content %}
    <div class="row mt-3">
        <div class="col-lg-4 col-md-5">
            <div class="card mb-3">
                <div class="card-body">
                    Charge Beacon notifies you about EV charger updates in your area.
                </div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">Step 1: Configure your search</li>
                    <li class="list-group-item">Step 2: Subscribe to the RSS feed</li>
                </ul>
                <div class="card-footer text-body-secondary">
                    <a href="{{ feed_url }}" id="updates-feed-anchor">RSS Feed Link</a><br>
                    More notification options coming soon!
                </div>
            </div>

            {% include 'app/search/search_form.html' %}
        </div>

        <div class="col-lg-8 col-md-7" id="updates-container">
            {% include 'app/updates_body.html' %}
        </div>

    </div>

    {% include 'app/footer.html' %}
{% endblock %}
